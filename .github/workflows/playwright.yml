name: Playwright Tests
on:
  push:
    branches: [playwright-github-actions]
  pull_request:
    branches: [playwright-github-actions]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

        # Install dependencies for all apps
      - name: Install dependencies
        run: yarn install

        # Build all frontend apps
      - name: Build frontend apps
        run: yarn build && yarn build:api

      # Start the Strapi backend app
      - name: Start Strapi backend
        run: yarn start-api &
        env:
          NODE_ENV: production

      # Wait for the backend app to start
      - name: Wait for Strapi backend to start
        run: |
          while ! nc -z localhost 1337; do sleep 1; done

      # Start all frontend apps
      - name: Start frontend apps
        run: |
          yarn start-frontend-1 &
          yarn start-frontend-2 &
          yarn start-frontend-3 &
          yarn start-frontend-4

      # Wait for all frontend apps to start
      - name: Wait for frontend apps to start
        run: |
          while ! nc -z localhost 3000; do sleep 1; done
          while ! nc -z localhost 3001; do sleep 1; done
          while ! nc -z localhost 3002; do sleep 1; done
          while ! nc -z localhost 3003; do sleep 1; done

      # Run tests
      - name: Run tests
        run: yarn test
