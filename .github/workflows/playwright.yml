name: Playwright Tests
on:
  push:
    branches: [playwright-github-actions, pr]
  pull_request:
    branches: [dev]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

        # Install dependencies for all apps
      - name: Install dependencies
        run: yarn install

        # Build all frontend apps
      - name: Build all apps
        run: yarn build

      # Start all frontend apps
      - name: Start all apps
        run: yarn start
        env:
          NODE_ENV: production
          USERNAME: ${{ secrets.username }}
          PASSWORD: ${{ secrets.password }}
          NEXT_PUBLIC_API_URL: https://wsvv-api-staging.onrender.com

      # Wait for all frontend apps to start
      - name: Wait for all apps to start
        run: |
          while ! nc -z localhost 3000; do sleep 1; done
          while ! nc -z localhost 3001; do sleep 1; done
          while ! nc -z localhost 3002; do sleep 1; done
          while ! nc -z localhost 3003; do sleep 1; done

      # Run tests
      - name: Run tests
        run: yarn test
